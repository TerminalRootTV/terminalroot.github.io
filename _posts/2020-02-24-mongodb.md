---
layout: post
title: "Tutorial de MongoDB para Iniciantes"
date: 2020-02-24 22:06:18
image: '/assets/img/mongodb/mongodb.png'
description: 'Diversos sites grandes principalmente Web Commerces usam o MongoDB.'
tags:
- mongodb
- nosql
- sql
- mysql
---

![Tutorial de MongoDB para Iniciantes](/assets/img/mongodb/mongodb.png)

[MongoDB](https://www.mongodb.com/) é um software de banco de dados orientado a documentos livre, de código aberto e multiplataforma, escrito na linguagem [C++](https://terminalroot.com.br/cpp).

Classificado como um programa de banco de dados [NoSQL](https://pt.wikipedia.org/wiki/NoSQL)(termo genérico que representa os bancos de dados não relacionais, ou seja, não se baseia no princípio de que todos os dados estão armazenados em tabelas).

O [MongoDB](https://pt.wikipedia.org/wiki/MongoDB) usa documentos semelhantes a [JSON](https://www.json.org/) com esquemas.

É desenvolvido pela [MongoDB Inc.](https://www.mongodb.com/company) e publicado sob uma combinação da [GNU Affero General Public License](https://www.gnu.org/licenses/agpl-3.0.en.html) e [Licença Apache](https://www.apache.org/licenses/LICENSE-2.0).

<!-- QUADRADO -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
style="display:inline-block;width:336px;height:280px"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="5351066970"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

# Modelo de dados
> Como os dados são guardados no MongoDB(estilo JSON), por isso é um banco de dados não relacional(diferentemente do MySQL, Oracle, PostgreSQL, SQLite,...).

Modelo Relacional:
![Modelo Relacional](/assets/img/mongodb/rdbms.png)

Modelo MongoDB(NÃO Relacional):
![NÃO Relacional JSON](/assets/img/mongodb/model-no-relacional.jpg)

# Terminologias no MongoDB
### Base de dados
O banco de dados é um contêiner físico para coleções.

### Coleção
Coleção é um grupo de documentos do MongoDB. É o equivalente a uma tabela RDBMS.

<!-- MINI ANÚNCIO -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Games Root -->
<ins class="adsbygoogle"
style="display:inline-block;width:730px;height:95px"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="5351066970"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

### Documento
Um documento é um conjunto de pares de valores-chave. Os documentos têm esquema dinâmico.

### Comparação com os nomes usados em SQL
| RDBMS | MongoDB |
|---|---|
| Banco de Dados | Banco de Dados |
| Tabela | Coleção |
| Linha | Documento |
| Coluna | Campo |
| Junção de tabela | Documentos incorporados |
| Chave Primária | Chave Primária (chave padrão _id fornecida pelo próprio mongodb) |
| mysqld/oracle | mongod |
| mysql/sqlplus | mongo |

### Documento de exemplo
O exemplo a seguir mostra a estrutura do documento de um blog, que é simplesmente um par de valores-chave separados por vírgula.
```js
{
   _id: ObjectId(7df78ad8902c)
   title: 'Visão geral do MongoDB',
   description: 'MongoDB, um banco de dados NoSQL',
   by: 'Marcos Oliveira',
   url: 'https://www.terminalroot.com.br',
   tags: ['mongodb', 'database', 'NoSQL'],
   likes: 100,
   comments: [
      {
         user:'user1',
         message: 'Meu primeiro comentário',
         dateCreated: new Date(2011,1,20,2,15),
         like: 0
      },
      {
         user:'user2',
         message: 'Meu segundo comentário',
         dateCreated: new Date(2011,1,25,7,45),
         like: 5
      }
   ]
}
```

<!-- RETANGULO LARGO 2 -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
style="display:block; text-align:center;"
data-ad-layout="in-article"
data-ad-format="fluid"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="8549252987"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

# Vantagens do MongoDB
Diversos sites grandes, principalmente, webcommerces usam o MongoDB, pois gera muito trabalho e processamento do servidor ao criar seleção de dados variados de um único produto.

Por exemplo, um notebook existem diversos dados descritivos: marca, modelo, série, descrição, cor,... e isso pra quem programa banco de dados sabe a "dor de cabeça" que é criar essas relações em SQL . Mas com o MongoDB isso isso bem simples.

Entre diversas áreas como:
- Big Data
- Infraestrutura móvel e social
- Gerenciamento de dados do usuário
- DataHub
Utilizam o MongoDB.

# Instalação
Antes de qualquer coisa, é necessário possuir o sistema de arquivos [XFS](https://docs.mongodb.com/manual/administration/production-notes/#kernel-and-file-systems) habilitado no [Kernel](https://github.com/torvalds/linux/), pois o MongoDB o utiliza junto com a [GNU C Library](http://www.gnu.org/software/libc/), mais conhecida como [glibc](http://www.gnu.org/software/libc/):
```sh
su
cd /usr/src/linux
make menuconfig
```

<!-- RETANGULO LARGO -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Informat -->
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="2327980059"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

Habilite de acordo com essas imagens:

![File System Kernel Linux](/assets/img/mongodb/fs-kernel-linux.jpg)
![XFS Kernel Linux](/assets/img/mongodb/xfs-kernel-linux.jpg)

Depois reconstrua e reinicie o computador:
```sh
make && make modules_install && make install
grub-mkconfig -o /boot/grub/grub.cfg
reboot
```

No [Gentoo](https://gentoo.org/) basta rodar o comando(ou sem `sudo` com o usuário `root`, `su -c "emerge dev-db/mongodb"`):
> Use `--ask` ou somente `-a` como parâmetro, e se quiser não adiconar ao *world* use `--oneshot` ou simplesmente `-1`, exemplo: `sudo emerge -a1 dev-db/mongodb`

```sh
sudo emerge dev-db/mongodb
```

Após instalar, é necessário criar um diretório na raiz do seu sistema para que o MongoDB crie o diretório para bancos de dados:
```sh
sudo mkdir -p /data/db/
```

Agora confira se já há um grupo `mongodb` criado com o comando:
```sh
cat /etc/group | cut -d: -f1 | grep mongodb
```
Se a saida for: **mongodb** , então tá tudo certo, se não for, você precisará criar esse grupo com o comando: `sudo groupadd mongodb`

<!-- QUADRADO -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
style="display:inline-block;width:336px;height:280px"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="5351066970"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

Agora adicione seu usuário à esse grupo:
> Após adicionar, será necessário deslogar e logar novamente no sistema para que as alterações tenham efeito.

```sh
sudo usermod -aG mongodb $USER
```

# Configurações
O arquivo de configuração do MongoDB pode ser localizado em: `cat /etc/mongodb.conf` e o mesmo contém as seguintes informações:
> As linhas 'comentadas'(iniciadas com *#* são ignoradas)

```sh
storage:
    dbPath: "/data/db"

systemLog:
    destination: file
    path: "/var/log/mongodb/mongodb.log"
    quiet: true
    logAppend: true

net:
    port: 27017
    bindIp: 127.0.0.1
```

Sobre as configurações:
- `dbPath: "/data/db"` - O caminho do MongoDB, se o seu estiver com `/var/lib/mongodb` altere para esse;
- `path: "/var/log/mongodb/mongodb.log"` - Onde são guardados os logs;
- `port: 27017` - A porta padrão, ou seja, você não precisa iniciar o MongoDB com o comando: `mongo --port 27017` se essa linha estiver devidamente configurada e "descomentada".
- `bindIp: 127.0.0.1` - Endereço de execução, ou seja, o loopback, se quiser alterar para um endereço específico, use essa linha.

<!-- MINI ANÚNCIO -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Games Root -->
<ins class="adsbygoogle"
style="display:inline-block;width:730px;height:95px"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="5351066970"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

Para evitar problemas de permissão, recomendo você excluir tudo que possa existir dentro do diretório: `/var/lib/mongodb`
```sh
sudo rm /var/lib/mongodb/*
```

Após isso, é necessário iniciar o daemon, nesse caso para o [OpenRC](https://wiki.gentoo.org/wiki/OpenRC):
> Se você usa SystemD, veja o comando equivalente aqui: <https://wiki.gentoo.org/wiki/OpenRC_to_systemd_Cheatsheet>

```sh
sudo rc-service mongodb start
```
Se quiser que o MongoDB seja iniciado automaticamente sempre que você iniciar seu sistema, rode:
```sh
sudo rc-update add mongodb default
```
> Se quiser conferir se o serviço já está rodando, use um desses comandos: `rc-service mongodb status`.

Exemplo:
![OpenRC MongoDB](/assets/img/mongodb/openrc-mongodb.png)


Após devidamente configurado, é só entrar no MongoDB via [shell](https://terminalroot.com.br/shell):
```sh
mongo
```

Para sair do MongoDB, basta rodar o comando: `exit`.

# Criando um usuário administrador
No shell mongo, adicione um usuário com a função `userAdminAnyDatabase` no banco de dados `admin`. Inclua funções adicionais conforme necessário para este usuário. Por exemplo, o seguinte cria o usuário `nomeDoUsuario` no banco de dados `admin` com a função `userAdminAnyDatabase` e a função `readWriteAnyDatabase`.
> A partir da versão 4.2 do mongo shell, é possível usar o método `passwordPrompt()` em conjunto com vários métodos/comandos de autenticação/gerenciamento de usuários para solicitar a senha, em vez de especificar a senha diretamente na chamada de método/comando. No entanto, você ainda pode especificar a senha diretamente como faria com as versões anteriores do shell mongo.

```js
use admin
db.createUser(
  {
    user: "nomeDoUsuario",
    pwd: passwordPrompt(), // ou pwd: "abc123", ou até mesmo senha em branco
    roles: [ { role: "userAdminAnyDatabase", db: "admin" }, "readWriteAnyDatabase" ] // total privilégios
  }
)
```
> Se quiser copie e cole o código(Shift + Control + V , para colar no terminal) com as devidas alterações realizadas, exemplo de saída:

```sh
Successfully added user: {
	"user" : "marcos",
	"roles" : [
		{
			"role" : "userAdminAnyDatabase",
			"db" : "admin"
		},
		"readWriteAnyDatabase"
	]
}
```

<!-- MINI ANÚNCIO -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Games Root -->
<ins class="adsbygoogle"
style="display:inline-block;width:730px;height:95px"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="5351066970"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

Saia do *shell mongo* `exit` . Agora para logar os parâmetros são similares ao do [MySQL](https://terminalroot.com.br/mysql):
```sh
mongo -u nomeDoUsuario -p
# MongoDB shell version v4.2.2
# Enter password: [INSIRA_SUA_SENHA]
```
> Ou com mais detalhes: `mongo --port 27017  --authenticationDatabase "admin" -u "nomeDoUsuario" -p`

### [Opcional] - Crie usuários adicionais se necessário
Perceba que ele só terá permissão específicas `read` e/ou `readWrite` em bancos específicos também: `test` e `reporting`
```js
use test
db.createUser(
  {
    user: "usuarioNormal",
    pwd:  passwordPrompt(),   // or cleartext password
    roles: [ { role: "readWrite", db: "test" },
             { role: "read", db: "reporting" } ]
  }
)
```
Depois é só logar com esse usuário: `mongo --port 27017 -u "usuarioNormal" --authenticationDatabase "test" -p`.

<!-- MINI ANÚNCIO -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Games Root -->
<ins class="adsbygoogle"
style="display:inline-block;width:730px;height:95px"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="5351066970"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

Na documentação tem detalhes para situações gerais, se quiser [dê uma olhada]([documentação](https://docs.mongodb.com/manual/tutorial/enable-authentication/).

# Usando o MongoDB (Comandos)
- Bancos de dados (databases)
  - `show dbs` - Lista todos os bancos de dados, o alias desse comando é `show databases`;
  - `use [nome-do-banco]` - Selecionar um banco de dados, ex.: `use admin`;
  - `db` - Verifica qual o banco de dados em uso no momento;
  - `use terminalroot` - Cria um banco de dados, mas só passa a existir efetivamente quando você cria uma collection e insere algum dado nela, se não o mesmo não estará disponível quando você listar os bancos, deixará de existir;
  - `db.dropDatabase()` - [Apaga um banco de dados](https://docs.mongodb.com/manual/reference/method/db.dropDatabase/), usar após selecionar `use nome-do-banco` que deseja;

  <!-- QUADRADO -->
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
  style="display:inline-block;width:336px;height:280px"
  data-ad-client="ca-pub-2838251107855362"
  data-ad-slot="5351066970"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

- Collections (tabelas)
  - `show collections` - Mostra as collections;
  - `createCollection()` - Cria uma collection, protótipo dela é `createCollection("nomeDaTabela", Opções)`, exemplo: `db.createCollection("minhacolecao")`.
  - `db.NOME_DA_COLECAO.find().pretty()` - Ler todos os dados de uma coleção, ex.: `db.system.users.find().pretty()` , ler todos os dados da coleção `system.users`, equivalente à `SELECT * FROM tabela`. Essa saída sairá formatada, se quiser os dados numa única linha, use sem o método `.pretty()`: `db.system.users.find()`;
  - `db.NOME_DA_COLECAO.insert()` - Insere dados numa coleção, ex.: `db.minhacolecao.insert( { "_id" : 0, "site" : "Terminal Root", "url" : "terminalroot.com.br", "content" : "Sobre MongoDB" } )`;
  - `db.NOME_DA_COLECAO.update(CONSULTA, O_QUE_ATUALIZAR, Opções)` - Atualiza(UPDATE) dados em um Documento(campo), ex.: `db.minhacolecao.update({'content':'Sobre MongoDB'},{$set:{'content':'MongoDB Definitivo Tutorial'}})`, altera o documento de nome **content** que tem o valor: **Sobre MongoDB** por **MongoDB Definitivo Tutorial**;
  - `db.NOME_DA_COLECAO.drop()` - Deleta uma coleção, ex.: `db.minhacolecao.drop()`, deleta a coleção **minhacolecao**.

- `help` saída conforme imagem abaixo:
![help MongoDB](/assets/img/mongodb/help-mongodb.png)

Veja a imagem abaixo de alguns comandos que citamos:
![Comando MongoDB Terminal Root](/assets/img/mongodb/commands-mongodb.png)

Para mais comandos consulte a [referência das comparações](https://docs.mongodb.com/manual/reference/sql-comparison/) e se já souber SQL e deseja *traduzir* o comando para MongoDB use o [QueryMongo](http://www.querymongo.com/). =)

# Mais informações de comandos
```sh
# Shell
mongo --help
man mongo

# Servidor
mongod --help
man mongod

# Utilitário de Despejo de Dados
mongodump --help
man mongodump

# Utilitário de Exportação
mongoexport --help
man mongoexport

# Utilitário GridFS
mongofiles --help
man mongofiles

# Utilitário de Importação
mongoimport --help
man mongoimport

# Ferramenta de captura e repetição de tráfego
mongoreplay --help
man mongoreplay

# Ferramenta de restauração de dados
mongorestore --help
man mongorestore

# Roteador de Consulta de Cluster
mongos --help
man mongos

# Utilitário de estatísticas
mongostat --help
man mongostat

# Monitor de Atividade
mongotop --help
man mongotop
```

<!-- RETANGULO LARGO 2 -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
style="display:block; text-align:center;"
data-ad-layout="in-article"
data-ad-format="fluid"
data-ad-client="ca-pub-2838251107855362"
data-ad-slot="8549252987"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

# Links úteis
- <https://fantinel.dev/mongodb-error-datadb-on-linux/>
- <https://www.tutorialspoint.com/mongodb/mongodb_quick_guide.htm>
- <https://cheatography.com/amicheletti/cheat-sheets/mongoengine/>
- <https://docs.mongodb.com/manual/reference/mongo-shell/>
- <https://gist.github.com/michaeltreat/d3bdc989b54cff969df86484e091fd0c>
- <https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/>
- <https://hevodata.com/blog/install-mongodb-on-ubuntu/>
- <https://docs.mongodb.com/manual/reference/method/db.dropUser/#db.dropUser>
- <https://stackoverflow.com/questions/4837673/how-to-execute-mongo-commands-through-shell-scripts>
- <https://stackoverflow.com/questions/15229412/unable-to-create-open-lock-file-data-mongod-lock-errno13-permission-denied>
- <https://pt.wikipedia.org/wiki/Dump_de_banco_de_dados>
